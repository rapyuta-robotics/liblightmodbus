<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>liblightmodbus: Slave device</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">liblightmodbus
   &#160;<span id="projectnumber">3.0</span>
   </div>
   <div id="projectbrief">A lightweight, header-only, hardware-agnostic Modbus RTU/TCP library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('slave.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Slave device </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In order to use slave side functions, make sure to define <code>LIGHTMODBUS_SLAVE</code> macro and enable necessary functions (e.g. <code>LIGHTMODBUS_F03S</code>) before including the library. Please also see <a class="el" href="building.html">Building and integrating liblightmodbus</a> for more information.</p>
<h1><a class="anchor" id="slave-init"></a>
Slave initialization</h1>
<p>Slave device state is represented by <code><a class="el" href="structModbusSlave.html" title="Slave device status.">ModbusSlave</a></code> structure. It must be initialized with <code><a class="el" href="slave_8h.html#a2c30507da9547125c17f62e0e18d9194" title="Initializes slave device.">modbusSlaveInit()</a></code> before it is used: </p><div class="fragment"><div class="line"><a class="code" href="structModbusSlave.html">ModbusSlave</a> slave;</div>
<div class="line"><a class="code" href="structModbusErrorInfo.html">ModbusErrorInfo</a> err;</div>
<div class="line">err = <a class="code" href="slave_8h.html#a2c30507da9547125c17f62e0e18d9194">modbusSlaveInit</a>(</div>
<div class="line">    &amp;slave,          </div>
<div class="line">    myRegisterCallback,              <span class="comment">// Callback for register operations</span></div>
<div class="line">    myExceptionCallback,             <span class="comment">// Callback for handling slave exceptions (optional)</span></div>
<div class="line">    <a class="code" href="base_8h.html#a85c4c4d0226d45b625c75912467aba44">modbusDefaultAllocator</a>,          <span class="comment">// Memory allocator for allocating responses</span></div>
<div class="line">    <a class="code" href="slave_8h.html#a0c75d5358eca0b3d71261269c55870d3">modbusSlaveDefaultFunctions</a>,     <span class="comment">// Set of supported functions</span></div>
<div class="line">    <a class="code" href="slave_8h.html#a1ed4f578aa9ac64591f7da2a50aca910">modbusSlaveDefaultFunctionCount</a>  <span class="comment">// Number of supported functions</span></div>
<div class="line">    );</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check for errors</span></div>
<div class="line">assert(<a class="code" href="base_8h.html#a64880e7075f445881485396f3aa869c5">modbusIsOk</a>(err) &amp;&amp; <span class="stringliteral">&quot;modbusSlaveInit() failed&quot;</span>); </div>
<div class="ttc" id="abase_8h_html_a64880e7075f445881485396f3aa869c5"><div class="ttname"><a href="base_8h.html#a64880e7075f445881485396f3aa869c5">modbusIsOk</a></div><div class="ttdeci">static uint8_t modbusIsOk(ModbusErrorInfo err)</div><div class="ttdoc">Checks if ModbusErrorInfo contains an error.</div><div class="ttdef"><b>Definition:</b> base.h:424</div></div>
<div class="ttc" id="abase_8h_html_a85c4c4d0226d45b625c75912467aba44"><div class="ttname"><a href="base_8h.html#a85c4c4d0226d45b625c75912467aba44">modbusDefaultAllocator</a></div><div class="ttdeci">ModbusError modbusDefaultAllocator(ModbusBuffer *buffer, uint16_t size, void *context)</div><div class="ttdoc">The default memory allocator based on realloc()</div><div class="ttdef"><b>Definition:</b> base.impl.h:21</div></div>
<div class="ttc" id="aslave_8h_html_a0c75d5358eca0b3d71261269c55870d3"><div class="ttname"><a href="slave_8h.html#a0c75d5358eca0b3d71261269c55870d3">modbusSlaveDefaultFunctions</a></div><div class="ttdeci">ModbusSlaveFunctionHandler modbusSlaveDefaultFunctions[]</div><div class="ttdoc">Associates function IDs with pointers to functions responsible for parsing. Length of this array is s...</div><div class="ttdef"><b>Definition:</b> slave.impl.h:18</div></div>
<div class="ttc" id="aslave_8h_html_a1ed4f578aa9ac64591f7da2a50aca910"><div class="ttname"><a href="slave_8h.html#a1ed4f578aa9ac64591f7da2a50aca910">modbusSlaveDefaultFunctionCount</a></div><div class="ttdeci">const uint8_t modbusSlaveDefaultFunctionCount</div><div class="ttdoc">Stores length of modbusSlaveDefaultFunctions.</div><div class="ttdef"><b>Definition:</b> slave.impl.h:60</div></div>
<div class="ttc" id="aslave_8h_html_a2c30507da9547125c17f62e0e18d9194"><div class="ttname"><a href="slave_8h.html#a2c30507da9547125c17f62e0e18d9194">modbusSlaveInit</a></div><div class="ttdeci">ModbusErrorInfo modbusSlaveInit(ModbusSlave *status, ModbusRegisterCallback registerCallback, ModbusSlaveExceptionCallback exceptionCallback, ModbusAllocator allocator, const ModbusSlaveFunctionHandler *functions, uint8_t functionCount)</div><div class="ttdoc">Initializes slave device.</div><div class="ttdef"><b>Definition:</b> slave.impl.h:76</div></div>
<div class="ttc" id="astructModbusErrorInfo_html"><div class="ttname"><a href="structModbusErrorInfo.html">ModbusErrorInfo</a></div><div class="ttdoc">Richer error represenation - source and type of error.</div><div class="ttdef"><b>Definition:</b> base.h:118</div></div>
<div class="ttc" id="astructModbusSlave_html"><div class="ttname"><a href="structModbusSlave.html">ModbusSlave</a></div><div class="ttdoc">Slave device status.</div><div class="ttdef"><b>Definition:</b> slave.h:87</div></div>
</div><!-- fragment --><p><a class="el" href="structModbusSlave.html" title="Slave device status.">ModbusSlave</a> contains an internal <a class="el" href="structModbusBuffer.html">ModbusBuffer</a> for the response data. This buffer relies on the allocator passed to <a class="el" href="slave_8h.html#a2c30507da9547125c17f62e0e18d9194" title="Initializes slave device.">modbusSlaveInit()</a> as an argument. <a class="el" href="base_8impl_8h.html#a85c4c4d0226d45b625c75912467aba44">modbusDefaultAllocator</a> is a default allocator that uses <code>malloc()</code> and <code>free()</code> functions. You may write your own more sophisticated allocators if you wish - please refer to <a class="el" href="allocators.html">Custom allocators</a> for more details.</p>
<p>In this code <code>myRegisterCallback</code> is a name of a callback function that will be called for every register operation. In previous this versions of the library this functionality was optionally available as <code>LIGHTMODBUS_REGISTER_CALLBACK</code>. Now, all register operations are performed using callbacks. If you're sure that none of the used parsing functions use the callback, you can pass <code>NULL</code> as the argument. Importantly, all default parsing functions in the library <b>require</b> the callback to be set.</p>
<p><code>myExceptionCallback</code> is a name of a callback function that will be called every time slave reports an exception to the master. To disable this functionality, pass <code>NULL</code> as the callback.</p>
<p>The set of functions supported by the slave is determined by the 5th function argument - in this case <a class="el" href="slave_8impl_8h.html#a0c75d5358eca0b3d71261269c55870d3">modbusSlaveDefaultFunctions</a>. This argument is a pointer to an array of <a class="el" href="structModbusSlaveFunctionHandler.html" title="Associates Modbus function ID with a pointer to a parsing function.">ModbusSlaveFunctionHandler</a> structures which associate function codes with callbacks. Lifetime of this array must not be shorter than the lifetime of the slave. The length of this array should be provided as the last argument.</p>
<h1><a class="anchor" id="slave-register-callback"></a>
Register callback</h1>
<p>The register callback is a function matching <a class="el" href="slave_8h.html#ab7c98629a544e29ddd328d19ad1c647c">ModbusRegisterCallback</a> used by the library to operate on register values. The register callback must respond to four types of register queries (<a class="el" href="slave_8h.html#a9beec9b20c9bccb826fe2072c6362f88">ModbusRegisterQuery</a>) described further in this section.</p>
<p>The library guarantees that before each register is accessed a suitable access query will be made for it beforehand. This mechanism can guarantee that registers outside of valid range will never be accessed and allows the user to implement read/write protection for registers. However, all access queries are performed before the first R/W query, so creating cross-dependencies between registers (i.e. access rights to one register depend on the value of other register) will cause problems. It's best to disable "write multiple X" functions on such registers.</p>
<dl class="section note"><dt>Note</dt><dd>Tip: You can use the user pointer to access your register values from the callback without making them global. Use <code><a class="el" href="slave_8h.html#abbbf205b4c4a0b74b5ae29b865ca3262" title="Retreieves the custom context pointer.">modbusSlaveGetUserPointer()</a></code> and <code><a class="el" href="slave_8h.html#a0e716c502fbcd1785db66e545cec6b2d" title="Allows user to set the custom context pointer.">modbusSlaveSetUserPointer()</a></code> to pass a pointer to your data to the callback.</dd></dl>
<h2><a class="anchor" id="slave-register-callback-access"></a>
R/W access check queries</h2>
<p><code><a class="el" href="structModbusRegisterCallbackArgs.html#ac0bf7b5d09b8e5358d1233e446866d40" title="Type of request made to the register.">ModbusRegisterCallbackArgs::query</a></code> value of either <a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca68672dc5badc4bd15dd12c168502930d">MODBUS_REGQ_R_CHECK</a> or <a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca0c01fdc7e834c204e355a160790b9932">MODBUS_REGQ_W_CHECK</a> indicates that an access query is being made to the callback function. When <code><a class="el" href="structModbusRegisterCallbackArgs.html#ac0bf7b5d09b8e5358d1233e446866d40" title="Type of request made to the register.">ModbusRegisterCallbackArgs::query</a></code> is <a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca68672dc5badc4bd15dd12c168502930d">MODBUS_REGQ_R_CHECK</a>, read access is requested. <a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca0c01fdc7e834c204e355a160790b9932">MODBUS_REGQ_W_CHECK</a> means that write access is requested.</p>
<p>The type of the accessed register is provided to the function in <code><a class="el" href="structModbusRegisterCallbackArgs.html#a63a0bf455e6cf9bd078e28df72c2b740" title="Type of accessed data.">ModbusRegisterCallbackArgs::type</a></code>. The index of the register is stored in <code><a class="el" href="structModbusRegisterCallbackArgs.html#ac5c5eb97d6d21ffa4faa528c2a409d8f" title="Index of the register.">ModbusRegisterCallbackArgs::index</a></code> and the ID of the function requesting access is available in <code><a class="el" href="structModbusRegisterCallbackArgs.html#a4b9aa7794ff24a924d3c917140c32231" title="Function accessing the register.">ModbusRegisterCallbackArgs::function</a></code>.</p>
<p>The value stored in <code><a class="el" href="structModbusRegisterCallbackArgs.html#a3a33e19899353f94fede91e2b6259e90" title="Value of the register.">ModbusRegisterCallbackArgs::value</a></code> during a write access check contains the value of the register that will be written in a subsequent write request. In case of read requests the value stored in this variable may not be used.</p>
<p>When responding to an access query, the function must return a value via <code><a class="el" href="structModbusRegisterCallbackResult.html#ace247f046fbae54243e8303a295ec2f8" title="Exception to be reported.">ModbusRegisterCallbackResult::exceptionCode</a></code> in the <code>result</code> output argument. This value is treated as the exception code that the slave will report to the master. In order to grant access to a certain register, <a class="el" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72a9b1d7542c51969c3fa21c8f440e849b6">MODBUS_EXCEP_NONE</a> must be returned.</p>
<p>The return value of the register callback is checked by the library during the access check phase. Returning a value other than <a class="el" href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6eafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a> results in the slave reporting a <a class="el" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72ae02fd12fb65f8060a7662aa3ed69f0b3">MODBUS_EXCEP_SLAVE_FAILURE</a> exception to the master.</p>
<dl class="section note"><dt>Note</dt><dd>This functionality should not be relied upon and may be subject to change in future versions of the library. For your own safety, please always return <code>MODBUS_OK</code> from the callback and use the <code>result-&gt;exceptionCode</code> to report exceptions.</dd></dl>
<h2><a class="anchor" id="slave-register-callback-r"></a>
Read queries</h2>
<p>Read query is a request to read contents of some register. During such query <code><a class="el" href="structModbusRegisterCallbackArgs.html#ac0bf7b5d09b8e5358d1233e446866d40" title="Type of request made to the register.">ModbusRegisterCallbackArgs::query</a></code> is set to <a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca6b80870bbce488af3b4d8ae43e8b3308">MODBUS_REGQ_R</a>. Read query is always preceded with a <a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca68672dc5badc4bd15dd12c168502930d">MODBUS_REGQ_R_CHECK</a> query.</p>
<p>The type of the accessed register is provided to the function in <code><a class="el" href="structModbusRegisterCallbackArgs.html#a63a0bf455e6cf9bd078e28df72c2b740" title="Type of accessed data.">ModbusRegisterCallbackArgs::type</a></code>. The index of the register is stored in <code><a class="el" href="structModbusRegisterCallbackArgs.html#ac5c5eb97d6d21ffa4faa528c2a409d8f" title="Index of the register.">ModbusRegisterCallbackArgs::index</a></code> and the ID of the function reading the register is available in <code><a class="el" href="structModbusRegisterCallbackArgs.html#a4b9aa7794ff24a924d3c917140c32231" title="Function accessing the register.">ModbusRegisterCallbackArgs::function</a></code>. <code><a class="el" href="structModbusRegisterCallbackArgs.html#a3a33e19899353f94fede91e2b6259e90" title="Value of the register.">ModbusRegisterCallbackArgs::value</a></code> is unused.</p>
<p>The callback function must return the contents of the requested register via <code><a class="el" href="structModbusRegisterCallbackResult.html#a34208194d1a073e6e2d8526d017c8b4d" title="Register/coil value.">ModbusRegisterCallbackResult::value</a></code> in the <code>result</code> output argument.</p>
<p>The return value from the callback is ignored. </p><dl class="section note"><dt>Note</dt><dd>This functionality should not be relied upon and may be subject to change in future versions of the library. For your own safety, please always return <code>MODBUS_OK</code> from the callback.</dd></dl>
<h2><a class="anchor" id="slave-register-callback-w"></a>
Write queries</h2>
<p>Write query is a request to change contents of some register to given value. During such query <code><a class="el" href="structModbusRegisterCallbackArgs.html#ac0bf7b5d09b8e5358d1233e446866d40" title="Type of request made to the register.">ModbusRegisterCallbackArgs::query</a></code> is set to <a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca3d41fd03043bb3eb8332e2fc55f208a1">MODBUS_REGQ_W</a>. Write query is always preceded with a <a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca0c01fdc7e834c204e355a160790b9932">MODBUS_REGQ_W_CHECK</a> query.</p>
<p>The type of the accessed register is provided to the function in <code><a class="el" href="structModbusRegisterCallbackArgs.html#a63a0bf455e6cf9bd078e28df72c2b740" title="Type of accessed data.">ModbusRegisterCallbackArgs::type</a></code>. The index of the register is stored in <code><a class="el" href="structModbusRegisterCallbackArgs.html#ac5c5eb97d6d21ffa4faa528c2a409d8f" title="Index of the register.">ModbusRegisterCallbackArgs::index</a></code> and the ID of the function writing the register is available in <code><a class="el" href="structModbusRegisterCallbackArgs.html#a4b9aa7794ff24a924d3c917140c32231" title="Function accessing the register.">ModbusRegisterCallbackArgs::function</a></code>. The new value for the register is stored in <code><a class="el" href="structModbusRegisterCallbackArgs.html#a3a33e19899353f94fede91e2b6259e90" title="Value of the register.">ModbusRegisterCallbackArgs::value</a></code>.</p>
<p>Both value returned through the <code>result</code> argument and the return value from the function are ignored. </p><dl class="section note"><dt>Note</dt><dd>This functionality should not be relied upon and may be subject to change in future versions of the library. For your own safety, please always return <code>MODBUS_OK</code> from the callback and do not modify the <code>result</code> output argument during write queries.</dd></dl>
<h2><a class="anchor" id="slave-register-callback-summary"></a>
Summary</h2>
<p>The table below represents a brief summary of different queries should be handled. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Query type   </th><th class="markdownTableHeadNone"><code>args-&gt;value</code>   </th><th class="markdownTableHeadNone"><code>result-&gt;exceptionCode</code>   </th><th class="markdownTableHeadNone"><code>result-&gt;value</code>   </th><th class="markdownTableHeadNone">Return value    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca68672dc5badc4bd15dd12c168502930d">MODBUS_REGQ_R_CHECK</a>   </td><td class="markdownTableBodyNone">Undefined   </td><td class="markdownTableBodyNone">Must be set to exception code to be reported. <a class="el" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72a9b1d7542c51969c3fa21c8f440e849b6">MODBUS_EXCEP_NONE</a> otherwise.   </td><td class="markdownTableBodyNone">Ignored   </td><td class="markdownTableBodyNone">Returning value different than <a class="el" href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6eafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a> results in <a class="el" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72ae02fd12fb65f8060a7662aa3ed69f0b3">MODBUS_EXCEP_SLAVE_FAILURE</a> being reported by the slave. <b>Do not rely on this.</b>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca0c01fdc7e834c204e355a160790b9932">MODBUS_REGQ_W_CHECK</a>   </td><td class="markdownTableBodyNone">Value that will be written in the subsequent write request   </td><td class="markdownTableBodyNone">Must be set to exception code to be reported. <a class="el" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72a9b1d7542c51969c3fa21c8f440e849b6">MODBUS_EXCEP_NONE</a> otherwise.   </td><td class="markdownTableBodyNone">Ignored   </td><td class="markdownTableBodyNone">Returning value different than <a class="el" href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6eafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a> results in <a class="el" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72ae02fd12fb65f8060a7662aa3ed69f0b3">MODBUS_EXCEP_SLAVE_FAILURE</a> being reported by the slave. <b>Do not rely on this.</b>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca6b80870bbce488af3b4d8ae43e8b3308">MODBUS_REGQ_R</a>   </td><td class="markdownTableBodyNone">Undefined   </td><td class="markdownTableBodyNone">Ignored   </td><td class="markdownTableBodyNone">Must be set to the value of the register   </td><td class="markdownTableBodyNone">Ignored    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca3d41fd03043bb3eb8332e2fc55f208a1">MODBUS_REGQ_W</a>   </td><td class="markdownTableBodyNone">New value for the register   </td><td class="markdownTableBodyNone">Ignored   </td><td class="markdownTableBodyNone">Ignored   </td><td class="markdownTableBodyNone">Ignored   </td></tr>
</table>
<h2><a class="anchor" id="slave-register-callback-example"></a>
Example</h2>
<p>An example implementation of a register callback operating on registers stored in an array: </p><div class="fragment"><div class="line"><span class="preprocessor">#define REG_COUNT 16</span></div>
<div class="line"><span class="keyword">static</span> uint16_t registers[REG_COUNT];</div>
<div class="line"><span class="keyword">static</span> uint16_t inputRegisters[REG_COUNT];</div>
<div class="line"><span class="keyword">static</span> uint8_t coils[REG_COUNT / 8];          <span class="comment">// Each coil corresponds to one bit</span></div>
<div class="line"><span class="keyword">static</span> uint8_t discreteInputs[REG_COUNT / 8]; <span class="comment">// Each input corresponds to one bit</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6e">ModbusError</a> myRegisterCallback(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structModbusSlave.html">ModbusSlave</a> *status,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structModbusRegisterCallbackArgs.html">ModbusRegisterCallbackArgs</a> *args,</div>
<div class="line">    <a class="code" href="structModbusRegisterCallbackResult.html">ModbusRegisterCallbackResult</a> *result)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (args-&gt;<a class="code" href="structModbusRegisterCallbackArgs.html#ac0bf7b5d09b8e5358d1233e446866d40">query</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// R/W access check</span></div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca68672dc5badc4bd15dd12c168502930d">MODBUS_REGQ_R_CHECK</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca0c01fdc7e834c204e355a160790b9932">MODBUS_REGQ_W_CHECK</a>:</div>
<div class="line">            <span class="comment">// If result-&gt;exceptionCode of a read/write access query is not MODBUS_EXCEP_NONE,</span></div>
<div class="line">            <span class="comment">// an exception is reported by the slave. If result-&gt;exceptionCode is not set,</span></div>
<div class="line">            <span class="comment">// the behavior is undefined.</span></div>
<div class="line">            result-&gt;<a class="code" href="structModbusRegisterCallbackResult.html#ace247f046fbae54243e8303a295ec2f8">exceptionCode</a> = args-&gt;id &lt; REG_COUNT ? <a class="code" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72a9b1d7542c51969c3fa21c8f440e849b6">MODBUS_EXCEP_NONE</a> : <a class="code" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72a24c0a052194534fbcaae038eb52dbb34">MODBUS_EXCEP_ILLEGAL_ADDRESS</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Read register        </span></div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca6b80870bbce488af3b4d8ae43e8b3308">MODBUS_REGQ_R</a>:</div>
<div class="line">            <span class="keywordflow">switch</span> (args-&gt;<a class="code" href="structModbusRegisterCallbackArgs.html#a63a0bf455e6cf9bd078e28df72c2b740">type</a>)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code" href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112a399936691314c8b570aa8b8aa7742d0a">MODBUS_HOLDING_REGISTER</a>: result-&gt;<a class="code" href="structModbusRegisterCallbackResult.html#a34208194d1a073e6e2d8526d017c8b4d">value</a> = registers[args-&gt;id]; <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code" href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112a8c7413b96e4656037480902e88d1d784">MODBUS_INPUT_REGISTER</a>:   result-&gt;<a class="code" href="structModbusRegisterCallbackResult.html#a34208194d1a073e6e2d8526d017c8b4d">value</a> = inputRegsiters[args-&gt;id]; <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code" href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112adc8efd22a9222da954897e0f5925072b">MODBUS_COIL</a>:             result-&gt;<a class="code" href="structModbusRegisterCallbackResult.html#a34208194d1a073e6e2d8526d017c8b4d">value</a> = <a class="code" href="base_8h.html#aff2248343762719cdacf818e4dae3709">modbusMaskRead</a>(coils, args-&gt;id); <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code" href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112a14cdbb2f2145e4cf91f671072aeb9521">MODBUS_DISCRETE_INPUT</a>:   result-&gt;<a class="code" href="structModbusRegisterCallbackResult.html#a34208194d1a073e6e2d8526d017c8b4d">value</a> = <a class="code" href="base_8h.html#aff2248343762719cdacf818e4dae3709">modbusMaskRead</a>(discreteInputs, args-&gt;id); <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Write register</span></div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca3d41fd03043bb3eb8332e2fc55f208a1">MODBUS_REGQ_W</a>:</div>
<div class="line">            <span class="keywordflow">switch</span> (args-&gt;<a class="code" href="structModbusRegisterCallbackArgs.html#a63a0bf455e6cf9bd078e28df72c2b740">type</a>)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code" href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112a399936691314c8b570aa8b8aa7742d0a">MODBUS_HOLDING_REGISTER</a>: registers[args-&gt;id] = args-&gt;<a class="code" href="structModbusRegisterCallbackArgs.html#a3a33e19899353f94fede91e2b6259e90">value</a>; <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code" href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112adc8efd22a9222da954897e0f5925072b">MODBUS_COIL</a>:             <a class="code" href="base_8h.html#a5d9947eb500e2d0c87491a0adce53c2a">modbusMaskWrite</a>(coils, args-&gt;id, args-&gt;<a class="code" href="structModbusRegisterCallbackArgs.html#a3a33e19899353f94fede91e2b6259e90">value</a>); <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">default</span>:                      <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Always return MODBUS_OK</span></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6eafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a>;</div>
<div class="line">}</div>
<div class="ttc" id="abase_8h_html_a0b7f726dfaa2b4cf98aaaed1eb42fa72a24c0a052194534fbcaae038eb52dbb34"><div class="ttname"><a href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72a24c0a052194534fbcaae038eb52dbb34">MODBUS_EXCEP_ILLEGAL_ADDRESS</a></div><div class="ttdeci">@ MODBUS_EXCEP_ILLEGAL_ADDRESS</div><div class="ttdoc">Illegal data address.</div><div class="ttdef"><b>Definition:</b> base.h:223</div></div>
<div class="ttc" id="abase_8h_html_a0b7f726dfaa2b4cf98aaaed1eb42fa72a9b1d7542c51969c3fa21c8f440e849b6"><div class="ttname"><a href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72a9b1d7542c51969c3fa21c8f440e849b6">MODBUS_EXCEP_NONE</a></div><div class="ttdeci">@ MODBUS_EXCEP_NONE</div><div class="ttdef"><b>Definition:</b> base.h:221</div></div>
<div class="ttc" id="abase_8h_html_a2b4f849d9455a7247dd9a0c1dee46112a14cdbb2f2145e4cf91f671072aeb9521"><div class="ttname"><a href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112a14cdbb2f2145e4cf91f671072aeb9521">MODBUS_DISCRETE_INPUT</a></div><div class="ttdeci">@ MODBUS_DISCRETE_INPUT</div><div class="ttdoc">Discrete input.</div><div class="ttdef"><b>Definition:</b> base.h:238</div></div>
<div class="ttc" id="abase_8h_html_a2b4f849d9455a7247dd9a0c1dee46112a399936691314c8b570aa8b8aa7742d0a"><div class="ttname"><a href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112a399936691314c8b570aa8b8aa7742d0a">MODBUS_HOLDING_REGISTER</a></div><div class="ttdeci">@ MODBUS_HOLDING_REGISTER</div><div class="ttdoc">Holding register.</div><div class="ttdef"><b>Definition:</b> base.h:235</div></div>
<div class="ttc" id="abase_8h_html_a2b4f849d9455a7247dd9a0c1dee46112a8c7413b96e4656037480902e88d1d784"><div class="ttname"><a href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112a8c7413b96e4656037480902e88d1d784">MODBUS_INPUT_REGISTER</a></div><div class="ttdeci">@ MODBUS_INPUT_REGISTER</div><div class="ttdoc">Input register.</div><div class="ttdef"><b>Definition:</b> base.h:236</div></div>
<div class="ttc" id="abase_8h_html_a2b4f849d9455a7247dd9a0c1dee46112adc8efd22a9222da954897e0f5925072b"><div class="ttname"><a href="base_8h.html#a2b4f849d9455a7247dd9a0c1dee46112adc8efd22a9222da954897e0f5925072b">MODBUS_COIL</a></div><div class="ttdeci">@ MODBUS_COIL</div><div class="ttdoc">Coil.</div><div class="ttdef"><b>Definition:</b> base.h:237</div></div>
<div class="ttc" id="abase_8h_html_a3e91ea9ea1b4d5927573e6ec1d1cce6e"><div class="ttname"><a href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6e">ModbusError</a></div><div class="ttdeci">ModbusError</div><div class="ttdoc">Represtents different kinds of errors.</div><div class="ttdef"><b>Definition:</b> base.h:127</div></div>
<div class="ttc" id="abase_8h_html_a3e91ea9ea1b4d5927573e6ec1d1cce6eafbb178df49063323a6dcbf03dd0d88d2"><div class="ttname"><a href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6eafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a></div><div class="ttdeci">@ MODBUS_OK</div><div class="ttdoc">No error.</div><div class="ttdef"><b>Definition:</b> base.h:133</div></div>
<div class="ttc" id="abase_8h_html_a5d9947eb500e2d0c87491a0adce53c2a"><div class="ttname"><a href="base_8h.html#a5d9947eb500e2d0c87491a0adce53c2a">modbusMaskWrite</a></div><div class="ttdeci">static void modbusMaskWrite(uint8_t *mask, uint16_t n, uint8_t value)</div><div class="ttdoc">Writes n-th bit in an array.</div><div class="ttdef"><b>Definition:</b> base.h:326</div></div>
<div class="ttc" id="abase_8h_html_aff2248343762719cdacf818e4dae3709"><div class="ttname"><a href="base_8h.html#aff2248343762719cdacf818e4dae3709">modbusMaskRead</a></div><div class="ttdeci">static uint8_t modbusMaskRead(const uint8_t *mask, uint16_t n)</div><div class="ttdoc">Reads n-th bit from an array.</div><div class="ttdef"><b>Definition:</b> base.h:315</div></div>
<div class="ttc" id="aslave_8h_html_af3b062fa65ce1ab33f86b8cbc9d250bca0c01fdc7e834c204e355a160790b9932"><div class="ttname"><a href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca0c01fdc7e834c204e355a160790b9932">MODBUS_REGQ_W_CHECK</a></div><div class="ttdeci">@ MODBUS_REGQ_W_CHECK</div><div class="ttdoc">Request for write access.</div><div class="ttdef"><b>Definition:</b> slave.h:39</div></div>
<div class="ttc" id="aslave_8h_html_af3b062fa65ce1ab33f86b8cbc9d250bca3d41fd03043bb3eb8332e2fc55f208a1"><div class="ttname"><a href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca3d41fd03043bb3eb8332e2fc55f208a1">MODBUS_REGQ_W</a></div><div class="ttdeci">@ MODBUS_REGQ_W</div><div class="ttdoc">Write request.</div><div class="ttdef"><b>Definition:</b> slave.h:41</div></div>
<div class="ttc" id="aslave_8h_html_af3b062fa65ce1ab33f86b8cbc9d250bca68672dc5badc4bd15dd12c168502930d"><div class="ttname"><a href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca68672dc5badc4bd15dd12c168502930d">MODBUS_REGQ_R_CHECK</a></div><div class="ttdeci">@ MODBUS_REGQ_R_CHECK</div><div class="ttdoc">Request for read access.</div><div class="ttdef"><b>Definition:</b> slave.h:38</div></div>
<div class="ttc" id="aslave_8h_html_af3b062fa65ce1ab33f86b8cbc9d250bca6b80870bbce488af3b4d8ae43e8b3308"><div class="ttname"><a href="slave_8h.html#af3b062fa65ce1ab33f86b8cbc9d250bca6b80870bbce488af3b4d8ae43e8b3308">MODBUS_REGQ_R</a></div><div class="ttdeci">@ MODBUS_REGQ_R</div><div class="ttdoc">Read request.</div><div class="ttdef"><b>Definition:</b> slave.h:40</div></div>
<div class="ttc" id="astructModbusRegisterCallbackArgs_html"><div class="ttname"><a href="structModbusRegisterCallbackArgs.html">ModbusRegisterCallbackArgs</a></div><div class="ttdoc">Contains arguments for the register callback function.</div><div class="ttdef"><b>Definition:</b> slave.h:48</div></div>
<div class="ttc" id="astructModbusRegisterCallbackArgs_html_a3a33e19899353f94fede91e2b6259e90"><div class="ttname"><a href="structModbusRegisterCallbackArgs.html#a3a33e19899353f94fede91e2b6259e90">ModbusRegisterCallbackArgs::value</a></div><div class="ttdeci">uint16_t value</div><div class="ttdoc">Value of the register.</div><div class="ttdef"><b>Definition:</b> slave.h:52</div></div>
<div class="ttc" id="astructModbusRegisterCallbackArgs_html_a63a0bf455e6cf9bd078e28df72c2b740"><div class="ttname"><a href="structModbusRegisterCallbackArgs.html#a63a0bf455e6cf9bd078e28df72c2b740">ModbusRegisterCallbackArgs::type</a></div><div class="ttdeci">ModbusDataType type</div><div class="ttdoc">Type of accessed data.</div><div class="ttdef"><b>Definition:</b> slave.h:49</div></div>
<div class="ttc" id="astructModbusRegisterCallbackArgs_html_ac0bf7b5d09b8e5358d1233e446866d40"><div class="ttname"><a href="structModbusRegisterCallbackArgs.html#ac0bf7b5d09b8e5358d1233e446866d40">ModbusRegisterCallbackArgs::query</a></div><div class="ttdeci">ModbusRegisterQuery query</div><div class="ttdoc">Type of request made to the register.</div><div class="ttdef"><b>Definition:</b> slave.h:50</div></div>
<div class="ttc" id="astructModbusRegisterCallbackResult_html"><div class="ttname"><a href="structModbusRegisterCallbackResult.html">ModbusRegisterCallbackResult</a></div><div class="ttdoc">Contains values returned by the slave register callback.</div><div class="ttdef"><b>Definition:</b> slave.h:60</div></div>
<div class="ttc" id="astructModbusRegisterCallbackResult_html_a34208194d1a073e6e2d8526d017c8b4d"><div class="ttname"><a href="structModbusRegisterCallbackResult.html#a34208194d1a073e6e2d8526d017c8b4d">ModbusRegisterCallbackResult::value</a></div><div class="ttdeci">uint16_t value</div><div class="ttdoc">Register/coil value.</div><div class="ttdef"><b>Definition:</b> slave.h:62</div></div>
<div class="ttc" id="astructModbusRegisterCallbackResult_html_ace247f046fbae54243e8303a295ec2f8"><div class="ttname"><a href="structModbusRegisterCallbackResult.html#ace247f046fbae54243e8303a295ec2f8">ModbusRegisterCallbackResult::exceptionCode</a></div><div class="ttdeci">ModbusExceptionCode exceptionCode</div><div class="ttdoc">Exception to be reported.</div><div class="ttdef"><b>Definition:</b> slave.h:61</div></div>
</div><!-- fragment --><h1><a class="anchor" id="slave-exception-callback"></a>
Slave exception callback</h1>
<p>Exception callback is a function matching <a class="el" href="slave_8h.html#ac21f10119a42e1b24d2d7362b3542c9e">ModbusSlaveExceptionCallback</a> called when the slave reports an exception. This callback is called even if the response frame is not sent to the master (e.g. when the exception is caused by a broadcasted request in Modbus RTU). This is an internal way of signalizing slave failure.</p>
<p>When called, the callback is provided with pointer to <a class="el" href="structModbusSlave.html">ModbusSlave</a>, function that reported the excepion and a <a class="el" href="base_8h.html#aa194a0d6fed2e0fd37e4f5b9d3747db5">ModbusExceptionCode</a>.</p>
<p>The exception callback must return <a class="el" href="base_8h.html#abe7d2ca32c0808656f4914bea803bc09">ModbusError</a>, but the return value is ignored. Preferably, it should return <a class="el" href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6eafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a>. </p><dl class="section note"><dt>Note</dt><dd>This functionality should not be relied upon and may be subject to change in future versions of the library. For your own safety, please always return <code>MODBUS_OK</code> from this callback.</dd></dl>
<p>An example of a simple callback, printing out exception information: </p><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">    Exception callback for printing out exceptions</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"><a class="code" href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6e">ModbusError</a> slaveExceptionCallback(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structModbusSlave.html">ModbusSlave</a> *slave,</div>
<div class="line">    uint8_t <span class="keyword">function</span>,</div>
<div class="line">    <a class="code" href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72">ModbusExceptionCode</a> code)</div>
<div class="line">{</div>
<div class="line">    printf(</div>
<div class="line">        <span class="stringliteral">&quot;Slave reports an exception %s (function %d)\n&quot;</span>,</div>
<div class="line">        <a class="code" href="debug_8h.html#adfffce55a1aa44629a0334ca7b93e767">modbusExceptionCodeStr</a>(code),</div>
<div class="line">        <span class="keyword">function</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Always return MODBUS_OK</span></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="base_8h.html#a3e91ea9ea1b4d5927573e6ec1d1cce6eafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a>;</div>
<div class="line">}</div>
<div class="ttc" id="abase_8h_html_a0b7f726dfaa2b4cf98aaaed1eb42fa72"><div class="ttname"><a href="base_8h.html#a0b7f726dfaa2b4cf98aaaed1eb42fa72">ModbusExceptionCode</a></div><div class="ttdeci">ModbusExceptionCode</div><div class="ttdoc">Represents a Modbus exception code.</div><div class="ttdef"><b>Definition:</b> base.h:220</div></div>
<div class="ttc" id="adebug_8h_html_adfffce55a1aa44629a0334ca7b93e767"><div class="ttname"><a href="debug_8h.html#adfffce55a1aa44629a0334ca7b93e767">modbusExceptionCodeStr</a></div><div class="ttdeci">const char * modbusExceptionCodeStr(ModbusExceptionCode code)</div><div class="ttdoc">Returns a string containing the name of the ModbusExceptionCode enum value.</div><div class="ttdef"><b>Definition:</b> debug.impl.h:67</div></div>
</div><!-- fragment --><h1><a class="anchor" id="slave-requests"></a>
Request processing</h1>
<p>After successful initialization of the slave device, it's ready to accept requests from the master. The requests can be processed using one of the three functions: <code><a class="el" href="slave_8h.html#ab5c5f3146a46cf8d221aca22e9c8a052" title="Parses provided PDU and generates PDU for the response frame.">modbusParseRequestPDU()</a></code>, <code><a class="el" href="slave_8h.html#a6a1e63faa64b7ca4b91d1ce7988be850" title="Parses provided Modbus RTU request frame and generates a Modbus RTU response.">modbusParseRequestRTU()</a></code> and <code><a class="el" href="slave_8h.html#a5ad3fe86aa14f8982d7c459c68cd8b3e" title="Parses provided Modbus TCP request frame and generates a Modbus TCP response.">modbusParseRequestTCP()</a></code>.</p>
<p>Calling each one of these results in an attempt to parse the request frame, a series of calls to the <a class="el" href="slave.html#slave-register-callback">Register callback</a>, an optional call to slave-exception callback and a response frame being generated for the master device.</p>
<p>The response frame can be accessed using <code><a class="el" href="slave_8h.html#a193bbc26c3169b8df63640fb42091621" title="Returns a pointer to the response generated by the slave.">modbusSlaveGetResponse()</a></code> and its length can be acquired using <code><a class="el" href="slave_8h.html#ab4cf50ac9f10ada660f679d4875b3fac" title="Returns the length of the response generated by the slave.">modbusSlaveGetResponseLength()</a></code>. These functions may not be called if <code><a class="el" href="base_8h.html#a64880e7075f445881485396f3aa869c5" title="Checks if ModbusErrorInfo contains an error.">modbusIsOk()</a></code> for the returned <code><a class="el" href="structModbusErrorInfo.html" title="Richer error represenation - source and type of error.">ModbusErrorInfo</a></code> is <code>false</code>.</p>
<dl class="section note"><dt>Note</dt><dd>In case the request is a Modbus RTU broadcast message, the response is still generated, but then discarded. Please ensure that you correctly handle <code><a class="el" href="slave_8h.html#ab4cf50ac9f10ada660f679d4875b3fac" title="Returns the length of the response generated by the slave.">modbusSlaveGetResponseLength()</a></code> return value of 0. While it may seem sub-optimal, it significantly simplifies the structure of parsing functions. Moreover, in case of read requests, it ensures that appropriate register read queries will always be made to the register callback function allowing the user to reliably act upon these events. Similarly, if the request triggers an exception, the <a class="el" href="slave.html#slave-exception-callback">Slave exception callback</a> is called, regardless of whether a response frame was produced. This is an internal way of signalizing a failure to comply.</dd></dl>
<div class="fragment"><div class="line"><span class="preprocessor">#define SLAVE_ADDRESS 7</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// For Modbus RTU</span></div>
<div class="line"><a class="code" href="structModbusErrorInfo.html">ModbusErrorInfo</a> err;</div>
<div class="line">err = <a class="code" href="slave_8h.html#a6a1e63faa64b7ca4b91d1ce7988be850">modbusParseRequestRTU</a>(&amp;slave, SLAVE_ADDRESS, buffer, length);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Handle &#39;serious&#39; errors such as memory allocation problems</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="base_8h.html#a84765449265aa5a31877b749f04cb568">modbusGetGeneralError</a>(&amp;slave))</div>
<div class="line">    handleSlaveError(err);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Handle errors related to the structure of the request frame</span></div>
<div class="line"><span class="comment">// i.e. frames meant for other slaves, invalid CRC etc.</span></div>
<div class="line"><span class="comment">// Usually, though, you want to simply ignore these.</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="base_8h.html#a5c6f792a259423b2df55d8d49e91fd06">modbusGetRequestError</a>(&amp;slave))</div>
<div class="line">    handleRequestErrors(err);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// If the function did not return an error, the response can be accessed and is ready to be sent</span></div>
<div class="line"><span class="comment">// to the master. The response frame can be acquired using modbusSlaveGetResponse()</span></div>
<div class="line"><span class="comment">// and is modbusSlaveGetResponseLength() bytes long. Beware that response frame can be empty</span></div>
<div class="line"><span class="comment">// in some cases!</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="base_8h.html#a64880e7075f445881485396f3aa869c5">modbusIsOk</a>(err))</div>
<div class="line">    sendToMaster(<a class="code" href="slave_8h.html#a193bbc26c3169b8df63640fb42091621">modbusSlaveGetResponse</a>(&amp;slave), <a class="code" href="slave_8h.html#ab4cf50ac9f10ada660f679d4875b3fac">modbusSlaveGetResponseLength</a>(&amp;slave));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Optionally, the response buffer can be freed now</span></div>
<div class="line"><a class="code" href="slave_8h.html#aac289ce160ea61287c98e8a1ee4353d5">modbusSlaveFreeResponse</a>(&amp;slave);</div>
<div class="ttc" id="abase_8h_html_a5c6f792a259423b2df55d8d49e91fd06"><div class="ttname"><a href="base_8h.html#a5c6f792a259423b2df55d8d49e91fd06">modbusGetRequestError</a></div><div class="ttdeci">static ModbusError modbusGetRequestError(ModbusErrorInfo err)</div><div class="ttdoc">Returns request error from ModbusErrorInfo.</div><div class="ttdef"><b>Definition:</b> base.h:444</div></div>
<div class="ttc" id="abase_8h_html_a84765449265aa5a31877b749f04cb568"><div class="ttname"><a href="base_8h.html#a84765449265aa5a31877b749f04cb568">modbusGetGeneralError</a></div><div class="ttdeci">static ModbusError modbusGetGeneralError(ModbusErrorInfo err)</div><div class="ttdoc">Returns general error from ModbusErrorInfo.</div><div class="ttdef"><b>Definition:</b> base.h:434</div></div>
<div class="ttc" id="aslave_8h_html_a193bbc26c3169b8df63640fb42091621"><div class="ttname"><a href="slave_8h.html#a193bbc26c3169b8df63640fb42091621">modbusSlaveGetResponse</a></div><div class="ttdeci">static const uint8_t * modbusSlaveGetResponse(const ModbusSlave *status)</div><div class="ttdoc">Returns a pointer to the response generated by the slave.</div><div class="ttdef"><b>Definition:</b> slave.h:144</div></div>
<div class="ttc" id="aslave_8h_html_a6a1e63faa64b7ca4b91d1ce7988be850"><div class="ttname"><a href="slave_8h.html#a6a1e63faa64b7ca4b91d1ce7988be850">modbusParseRequestRTU</a></div><div class="ttdeci">ModbusErrorInfo modbusParseRequestRTU(ModbusSlave *status, uint8_t slaveAddress, const uint8_t *request, uint16_t requestLength)</div><div class="ttdoc">Parses provided Modbus RTU request frame and generates a Modbus RTU response.</div><div class="ttdef"><b>Definition:</b> slave.impl.h:296</div></div>
<div class="ttc" id="aslave_8h_html_aac289ce160ea61287c98e8a1ee4353d5"><div class="ttname"><a href="slave_8h.html#aac289ce160ea61287c98e8a1ee4353d5">modbusSlaveFreeResponse</a></div><div class="ttdeci">static void modbusSlaveFreeResponse(ModbusSlave *status)</div><div class="ttdoc">Frees memory allocated for slave's response frame.</div><div class="ttdef"><b>Definition:</b> slave.h:189</div></div>
<div class="ttc" id="aslave_8h_html_ab4cf50ac9f10ada660f679d4875b3fac"><div class="ttname"><a href="slave_8h.html#ab4cf50ac9f10ada660f679d4875b3fac">modbusSlaveGetResponseLength</a></div><div class="ttdeci">static uint16_t modbusSlaveGetResponseLength(const ModbusSlave *status)</div><div class="ttdoc">Returns the length of the response generated by the slave.</div><div class="ttdef"><b>Definition:</b> slave.h:155</div></div>
</div><!-- fragment --><h1><a class="anchor" id="slave-cleanup"></a>
Slave cleanup</h1>
<p>In order to destroy the <a class="el" href="structModbusSlave.html" title="Slave device status.">ModbusSlave</a> structure, simply call <code><a class="el" href="slave_8h.html#a70695c3b7355bc0a3e6d49c46a4eef1f" title="Frees memory allocated in the ModbusSlave struct.">modbusSlaveDestroy()</a></code>: </p><div class="fragment"><div class="line"><a class="code" href="slave_8h.html#a70695c3b7355bc0a3e6d49c46a4eef1f">modbusSlaveDestroy</a>(&amp;slave);</div>
<div class="ttc" id="aslave_8h_html_a70695c3b7355bc0a3e6d49c46a4eef1f"><div class="ttname"><a href="slave_8h.html#a70695c3b7355bc0a3e6d49c46a4eef1f">modbusSlaveDestroy</a></div><div class="ttdeci">void modbusSlaveDestroy(ModbusSlave *status)</div><div class="ttdoc">Frees memory allocated in the ModbusSlave struct.</div><div class="ttdef"><b>Definition:</b> slave.impl.h:96</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
